#!/bin/bash

set -e

GREEN=$'\033[0;32m'
BLUE=$'\033[0;34m'
NC=$'\033[0m'

TOOL_NAME=$(basename "$0")
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
PROJECT_ROOT=$(dirname "$SCRIPT_DIR")
TOOL_ROOT="${PROJECT_ROOT}/tools/${TOOL_NAME}"
DOCKERFILE_PATH="${TOOL_ROOT}/Dockerfile"
IMAGE_NAME="customer-dashboard/${TOOL_NAME}:latest"

build_image() {
    echo "${BLUE}Building Docker image: ${IMAGE_NAME}...${NC}"
    docker build \
        --no-cache \
        -t "${IMAGE_NAME}" \
        -f "${DOCKERFILE_PATH}" \
        "${TOOL_ROOT}"
    echo "${GREEN}Build complete.${NC}"
}

if [[ "$1" == "rebuild" || "$1" == "--rebuild" ]]; then
    build_image
    exit 0
fi

if [[ -z "$(docker images -q "${IMAGE_NAME}")" ]]; then
    build_image
fi

docker run --rm -t \
    -v "${TOOL_ROOT}":/code \
    -v "${PROJECT_ROOT}":"${PROJECT_ROOT}" \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -e PROJECT_ROOT="${PROJECT_ROOT}" \
    --network="host" \
    "${IMAGE_NAME}" "$@"
